<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة الإدارة | Golden Cloud Server</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --navy: #0b1d2a; --gold: #ffcc00; --white: #ffffff;
            --danger: #ff4757; --warning: #ffa502; --success: #2ed573;
            --info: #3498db; --gray-light: #f8f9fa; --gray-dark: #2d3436;
            --shadow-sm: 0 5px 15px rgba(0,0,0,0.05); --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
        }

        * { box-sizing: border-box; transition: all 0.2s ease; }
        body { font-family: 'Tajawal', sans-serif; background-color: #f0f2f5; margin: 0; color: var(--gray-dark); }

        /* شريط المنصات الحكومية الجديد */
        /* شريط المنصات المطور بسحب أفقي */
.gov-bar {
    background: #fdfdfd;
    padding: 10px 20px;
    display: flex;
    gap: 12px;
    align-items: center;
    border-bottom: 2px solid #eee;
    overflow-x: auto; /* تفعيل السحب الأفقي */
    white-space: nowrap; /* منع العناصر من النزول لسطر جديد */
    scrollbar-width: thin; /* لمتصفحات فايرفوكس */
    scrollbar-color: var(--gold) #f0f0f0; /* لمتصفحات فايرفوكس */
}

/* تخصيص شكل شريط السحب (Scrollbar) لمتصفحات Chrome و Edge */
.gov-bar::-webkit-scrollbar {
    height: 6px; /* سمك خط السحب */
}

.gov-bar::-webkit-scrollbar-track {
    background: #f0f0f0; /* لون المسار */
    border-radius: 10px;
}

.gov-bar::-webkit-scrollbar-thumb {
    background: var(--gold); /* لون خط السحب (الذهبي) */
    border-radius: 10px;
}

.gov-bar::-webkit-scrollbar-thumb:hover {
    background: var(--navy); /* يتغير اللون عند تمرير الماوس */
}

.gov-link {
    text-decoration: none;
    color: var(--navy);
    padding: 6px 15px;
    border-radius: 8px;
    background: #eee;
    font-weight: 700;
    display: inline-flex; /* لضمان بقائها في سطر واحد */
    align-items: center;
    gap: 8px;
    flex-shrink: 0; /* منع العناصر من الانكماش */
}
        .chamber-dropdown {
            padding: 5px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-family: 'Tajawal';
            font-weight: bold;
            outline: none;
            cursor: pointer;
        }

        header {
            background: linear-gradient(135deg, var(--navy) 0%, #162e3e 100%);
            color: var(--gold); padding: 15px 40px; display: flex;
            justify-content: space-between; align-items: center;
            box-shadow: 0 4px 25px rgba(0,0,0,0.3); position: sticky; top: 0; z-index: 1000;
        }

        .logo-section { display: flex; align-items: center; gap: 20px; }
        .scope-badge { 
            background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 50px; 
            color: #fff; font-weight: 700; border: 1px solid var(--gold);
        }

        .container { max-width: 1600px; margin: 0 auto; padding: 30px; }
        
        /* الشبكة: جعلناها تبدأ من 250px لضمان اتساع النص المدمج */
.stats-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
    gap: 20px; 
    margin-bottom: 30px; 
}

/* التصميم العام للبطاقة - أزلنا الحافة الجانبية القديمة */
.stat-card { 
    background: var(--white); 
    padding: 20px; 
    border-radius: 15px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    box-shadow: var(--shadow-sm);
    position: relative;
}

/* الأيقونات والعناوين */
.stat-card i { font-size: 2rem; opacity: 0.2; }
.stat-card h3 { margin: 0; font-size: 0.9rem; color: #666; }

/* الرقم الكبير: أزلنا اللون الثابت هنا ليقبل ألوان الفئات أدناه */
.stat-card .value { font-size: 1.8rem; font-weight: 800; }

/* فئات الألوان الجديدة (تطبق الحد السفلي ولون الرقم) */
.stat-card.blue { border-bottom: 4px solid var(--info); }
.stat-card.blue .value { color: var(--info); }

.stat-card.pink { border-bottom: 4px solid #e84393; }
.stat-card.pink .value { color: #e84393; }

.stat-card.red { border-bottom: 4px solid var(--danger); }
.stat-card.red .value { color: var(--danger); }

.stat-card.green { border-bottom: 4px solid var(--success); }
.stat-card.green .value { color: var(--success); }
/* بطاقة التراخيص والسجلات (لون برتقالي تنبيهي) */
.stat-card.orange { border-bottom: 4px solid #f39c12 !important; }
.stat-card.orange .value { color: #f39c12 !important; }
        .toolbar { background: var(--white); padding: 20px; border-radius: 20px; margin-bottom: 30px; display: flex; gap: 15px; align-items: center; box-shadow: var(--shadow-sm); flex-wrap: wrap; }
        .search-wrapper { flex: 1; position: relative; min-width: 300px; }
        .search-wrapper input { width: 100%; padding: 12px 50px 12px 20px; border: 2px solid #eee; border-radius: 12px; font-size: 1rem; font-family: inherit; }
        .search-wrapper i { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: var(--navy); }

        .btn { padding: 10px 18px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-family: inherit; text-decoration: none; font-size: 0.85rem; }
        .btn-excel { background: #1d7a46; color: white; }
        .btn-link { background: var(--gold); color: var(--navy); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-whatsapp { background: #25D366; color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-edit { background: var(--warning); color: var(--navy); }
        .btn-licenses { background: var(--white); color: var(--navy); border: 2px solid var(--gold); }
        .btn-licenses:hover { background: var(--gold); }

        .table-card { background: var(--white); border-radius: 20px; box-shadow: var(--shadow-sm); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        thead th { background: var(--navy); color: var(--gold); padding: 18px; font-size: 0.9rem; }
        td { padding: 15px; text-align: center; border-bottom: 1px solid #f0f0f0; font-size: 0.95rem; }

        .details-grid, .edit-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 10px; }
        .info-mini-card {
            background: #f8f9fa; padding: 12px; border-radius: 12px;
            border-right: 4px solid var(--navy); display: flex; flex-direction: column; gap: 4px;
        }
        .info-mini-card.blue { border-right-color: var(--info); }
        .info-mini-card.green { border-right-color: var(--success); }
        .info-mini-card.orange { border-right-color: var(--warning); }
        .info-mini-card.pink { border-right-color: #e84393; } 
        
        .info-mini-card label { font-size: 0.75rem; color: #777; font-weight: bold; }
        .info-mini-card span { font-size: 0.95rem; color: var(--navy); font-weight: 800; }

        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group label { font-size: 0.8rem; font-weight: bold; color: var(--navy); }
        .form-group input, .form-group select { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.75); z-index:2000; backdrop-filter: blur(4px); overflow-y: auto; }
        .modal-content { background: #fff; width: 95%; max-width: 650px; margin: 5vh auto; border-radius: 20px; overflow: hidden; animation: zoomIn 0.3s; }
        @keyframes zoomIn { from {opacity: 0; transform: scale(0.9);} to {opacity: 1; transform: scale(1);} }
        .modal-header { padding: 15px 25px; background: var(--navy); color: var(--gold); display: flex; justify-content: space-between; align-items: center; }
        
        #toast { position: fixed; bottom: 30px; right: 30px; padding: 15px 30px; border-radius: 50px; display: none; z-index: 9999; color: white; box-shadow: var(--shadow-lg); font-weight: bold; }
        /* تنسيق مصفوفة الشهادات الصحية - 4 أعمدة */
.health-cards-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin: 20px 0 30px;
}
.health-card {
    background: white; border-radius: 12px; border-right: 6px solid #ccc; padding: 12px;
    height: 100px; display: flex; flex-direction: column; justify-content: space-between;
    box-shadow: var(--shadow-sm); cursor: pointer; position: relative; overflow: hidden;
}
.health-card.valid { border-right-color: var(--success); }
.health-card.warning { border-right-color: var(--warning); }
.health-card.expired { border-right-color: var(--danger); }
.health-card b { font-size: 0.85rem; color: var(--navy); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.health-card span { font-size: 0.75rem; color: #666; }
.health-card .icon-status { position: absolute; left: 10px; bottom: 10px; font-size: 1.2rem; opacity: 0.2; }

@media (max-width: 1100px) { .health-cards-grid { grid-template-columns: repeat(2, 1fr); } }
.filter-group {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}
.filter-btn {
    padding: 8px 15px;
    border-radius: 20px;
    border: 2px solid #ddd;
    background: #fff;
    cursor: pointer;
    font-weight: 700;
    font-size: 0.85rem;
    transition: all 0.3s ease;
}
.filter-btn.active { background: var(--navy); color: var(--gold); border-color: var(--navy); }
.filter-btn.exp { border-color: var(--danger); color: var(--danger); }
.filter-btn.exp.active { background: var(--danger); color: #fff; }
.filter-btn.near { border-color: var(--warning); color: #e67e22; }
.filter-btn.near.active { background: var(--warning); color: #fff; }
.filter-btn.valid { border-color: var(--success); color: var(--success); }
.filter-btn.valid.active { background: var(--success); color: #fff; }
    </style>
</head>
<body>
<header style="display: flex; justify-content: space-between; align-items: center;">
    <div class="logo-section" style="display: flex; align-items: center; gap: 20px;">
        <i class="fas fa-server fa-2x"></i>
        <div>
            <h2 style="margin:0">Golden Cloud Server</h2>
            <div id="scopeNameDisplay" class="scope-badge">جاري التحميل...</div>
        </div>
    </div>

    <div style="display: flex; gap: 10px; align-items: center; margin-right: auto;">
        <button class="btn" style="background: #0984e3; color: white; border: none;" onclick="goToWages()">
    <i class="fas fa-file-invoice-dollar"></i> إدارة الأجور
</button>
        <button class="btn btn-licenses" onclick="goToLicenses()">
            <i class="fas fa-file-contract"></i> السجلات والرخص
        </button>
        <button class="btn btn-link" onclick="copyRegLink()">
            <i class="fas fa-user-plus"></i> رابط التسجيل
        </button>
        <button class="btn" style="background: #2ed573; color: white; border: none;" onclick="goToHealthCertificates()">
            <i class="fas fa-heartbeat"></i> الشهادات الصحية
        </button>
        <button class="btn btn-danger" onclick="logout()">
            <i class="fas fa-power-off"></i> خروج
        </button>
    </div>
</header>
<div class="gov-bar">
    <span style="font-weight: 800; color: var(--navy); border-left: 2px solid #ddd; padding-left: 10px;">المنصات:</span>
    <a href="https://www.qiwa.sa" target="_blank" class="gov-link priority"><i class="fas fa-briefcase"></i> قوى</a>
    <a href="https://www.mudad.com.sa" target="_blank" class="gov-link priority"><i class="fas fa-coins"></i> مدد</a>
    <a href="https://www.absher.sa" target="_blank" class="gov-link priority"><i class="fas fa-user-shield"></i> أبشر</a>
    <a href="https://www.gosi.gov.sa" target="_blank" class="gov-link priority"><i class="fas fa-building"></i> التأمينات</a>
    <a href="https://muqeem.sa" target="_blank" class="gov-link">مقيم</a>
    <a href="https://zatca.gov.sa" target="_blank" class="gov-link">الزكاة والضريبة</a>
    <a href="https://balady.gov.sa" target="_blank" class="gov-link">بلدي</a>
    <a href="https://www.mc.gov.sa" target="_blank" class="gov-link">وزارة التجارة</a>
    <a href="https://saber.sa" target="_blank" class="gov-link">سابر</a>
    <a href="https://etimad.sa" target="_blank" class="gov-link">اعتماد</a>
    <a href="https://hrsd.gov.sa" target="_blank" class="gov-link">الموارد البشرية</a>
    <a href="https://www.najiz.sa" target="_blank" class="gov-link">ناجز</a>
    <a href="https://www.enjazit.com.sa" target="_blank" class="gov-link">إنجاز</a>
    <a href="https://www.saso.gov.sa" target="_blank" class="gov-link">المواصفات والمقاييس</a>
    <select class="chamber-dropdown" onchange="if(this.value) window.open(this.value, '_blank')">
        <option value="">-- الغرف التجارية --</option>
        <option value="https://www.riyadhchamber.com">غرفة الرياض</option>
        <option value="https://www.jcci.org.sa">غرفة جدة</option>
        <option value="https://www.chamber.org.sa">غرفة الشرقية</option>
        <option value="https://www.makkahchamber.org.sa">غرفة مكة</option>
        <option value="https://www.qcc.org.sa">غرفة القصيم</option>
        <option value="https://www.vcci.org.sa">غرفة أبها</option>
    </select>
</div>
<div class="container">
    <div class="stats-grid" id="statsContainer"></div>

    <div class="toolbar">
        <div class="search-wrapper">
            <i class="fas fa-search"></i>
            <input type="text" id="mainSearch" placeholder="ابحث بالاسم، الهوية، أو الجنسية..." onkeyup="handleSearch()">
        </div>
        <button class="btn btn-excel" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> تصدير إكسل</button>
        <button class="btn" style="background: var(--navy); color:white" onclick="init()"><i class="fas fa-sync"></i> تحديث</button>
    </div>
<div class="filter-group" id="statusFilters">
    <button class="filter-btn active" onclick="filterByStatus('all', this)">الكل</button>
    <button class="filter-btn exp" onclick="filterByStatus('expired', this)">منتهية ❌</button>
    <button class="filter-btn near" onclick="filterByStatus('near', this)">قريبة الانتهاء ⚠️</button>
    <button class="filter-btn valid" onclick="filterByStatus('valid', this)">سارية ✅</button>
</div>
    <div class="table-card">
        <table>
            <thead>
                <tr>
                    <th>الموظف</th>
                    <th>الجنسية</th>
                    <th>الهوية</th>
                    <th>الجوال</th>
                    <th>انتهاء الهوية</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody id="employeeTable">
                <tr><td colspan="6">جاري جلب البيانات...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="detailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="det_title" style="margin:0">تفاصيل الموظف</h3>
            <button onclick="closeModal('detailsModal')" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body" id="detailsBody" style="padding:20px"></div>
        <div style="padding: 15px; background: #f8f9fa; display: flex; gap: 10px;">
            <button id="btn_edit_trigger" class="btn btn-edit" style="flex:1; justify-content: center;"><i class="fas fa-edit"></i> تعديل البيانات</button>
            <button class="btn" style="background:var(--navy); color:white; flex:1; justify-content: center;" onclick="closeModal('detailsModal')">إغلاق</button>
        </div>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0">تحديث بيانات المستندات</h3>
            <button onclick="closeModal('editModal')" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        <form id="editForm" class="modal-body" style="padding:20px">
            <input type="hidden" id="edit_id">
            <div class="edit-grid">
                <div class="form-group"><label>الاسم الكامل</label><input type="text" id="edit_fullName" required></div>
                <div class="form-group"><label>رقم الجوال</label><input type="text" id="edit_phoneNumber" required></div>
                <div class="form-group"><label>الجنس</label>
                    <select id="edit_gender">
                        <option value="male">ذكر | Male</option>
                        <option value="female">أنثى | Female</option>
                    </select>
                </div>
                <div class="form-group"><label>الجنسية</label><input type="text" id="edit_nationality"></div>
                <div class="form-group"><label>تاريخ انتهاء الهوية</label><input type="date" id="edit_idExpiry" required></div>
                <div class="form-group"><label>تاريخ انتهاء الجواز</label><input type="date" id="edit_passportExpiry"></div>
                <div class="form-group"><label>رقم اللوحة (العهدة)</label><input type="text" id="edit_carPlate"></div>
                <div class="form-group"><label>التأمين الطبي</label>
                    <select id="edit_hasHealthInsurance">
                        <option value="true">✅ موجود</option>
                        <option value="false">❌ غير موجود</option>
                    </select>
                </div>
                <div class="form-group"><label>المسمى الوظيفي</label><input type="text" id="edit_jobTitle"></div>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button type="submit" class="btn btn-info" style="flex:2; justify-content: center;"><i class="fas fa-save"></i> حفظ التغييرات</button>
                <button type="button" class="btn" style="background:#eee; flex:1; justify-content: center;" onclick="closeModal('editModal')">إلغاء</button>
            </div>
        </form>
    </div>
</div>

<div id="toast"></div>

<script>
    let rawData = [];
    let scopeId = new URLSearchParams(window.location.search).get('scope');

    // 1. إدارة النطاق الآمن
    function getSafeScope() {
        if (!scopeId) {
            scopeId = localStorage.getItem('last_active_scope');
        } else {
            localStorage.setItem('last_active_scope', scopeId);
        }
        return scopeId;
    }

    // 2. التنقل (الرخص والشهادات الصحية)
    function goToLicenses() {
        const activeScope = getSafeScope();
        if(activeScope) {
            window.location.href = `/manager/licenses?scope=${activeScope}`;
        } else {
            showToast("كود النطاق مفقود، يرجى إعادة تسجيل الدخول", true);
        }
    }

    function goToHealthCertificates() {
        const activeScope = getSafeScope(); 
        if(activeScope) {
            window.location.href = `/health/view-certificates?scope=${activeScope}`;
        } else {
            showToast("عذراً: كود النطاق مفقود، يرجى إعادة تحميل الصفحة", true);
        }
    }
function goToWages() {
    const activeScope = getSafeScope();
    if(activeScope) {
        // التوجيه لصفحة الأجور المستقلة التي أنشأناها
        window.location.href = `/manager/wages?scope=${activeScope}`;
    } else {
        showToast("عذراً: كود النطاق مفقود، يرجى إعادة تحميل الصفحة", true);
    }
}
    // 3. التشغيل وجلب البيانات (تم التحديث لربط محرك الإحصائيات الشامل)
    async function init() {
        const activeScope = getSafeScope();
        if(!activeScope) {
            document.getElementById('employeeTable').innerHTML = '<tr><td colspan="6" style="color:red">خطأ: كود النطاق مفقود.</td></tr>';
            return;
        }
        await fetchScopeInfo(activeScope);
        await loadDashboardData(activeScope); // استخدام الدالة الشاملة الجديدة
    }

    async function fetchScopeInfo(id) {
        try {
            const res = await fetch(`/manager/api/get-scope-info/${id}`);
            if(!res.ok) throw new Error("Connection Error");
            const data = await res.json();
            document.getElementById('scopeNameDisplay').innerText = data.name || "نطاق رئيسي";
        } catch (e) { 
            document.getElementById('scopeNameDisplay').innerText = "خطأ في الاتصال بالسيرفر";
        }
    }

    // دالة جلب البيانات الشاملة (موظفين + صحة + رخص)
    async function loadDashboardData(id) {
        try {
            // تغيير المسار من get-employees إلى get-dashboard-data
            const res = await fetch(`/manager/api/get-dashboard-data/${id}`);
            if(!res.ok) throw new Error("DB Error");
            
            const response = await res.json();
            
            // توزيع البيانات
            rawData = response.employees; 
            renderTable(rawData);
            renderStats(response); // تمرير الكائن الكامل للإحصائيات
        } catch (e) { 
            showToast("⚠️ فشل الاتصال بقاعدة البيانات. يرجى التحديث", true);
            document.getElementById('employeeTable').innerHTML = '<tr><td colspan="6">حدث خطأ في جلب البيانات من السيرفر.</td></tr>';
        }
    }

    // 4. عرض البيانات والفلترة
    function renderTable(data) {
        const tbody = document.getElementById('employeeTable');
        if(!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">لا يوجد موظفين مسجلين حالياً.</td></tr>';
            return;
        }
        tbody.innerHTML = data.map(emp => {
            const isExp = emp.idExpiry && new Date(emp.idExpiry) < new Date();
            const waLink = `https://wa.me/${emp.phoneNumber?.replace(/\D/g,'')}?text=تحية طيبة، نود تذكيرك بتحديث بياناتك لدى غولدن كلاود`;
            return `
                <tr>
                    <td>
                        <div style="display:flex; align-items:center; gap:10px; justify-content:center">
                            <i class="fas ${emp.gender === 'female' ? 'fa-female' : 'fa-male'}" style="color:${emp.gender === 'female' ? '#e84393' : '#3498db'}"></i>
                            <b>${emp.fullName}</b>
                        </div>
                        <small style="color:#888">${emp.jobTitle || 'موظف'}</small>
                    </td>
                    <td><span style="background:#eee; padding:3px 10px; border-radius:5px; font-size:0.8rem">${emp.nationality || 'غير محدد'}</span></td>
                    <td><code>${emp.idNumber}</code></td>
                    <td>${emp.phoneNumber}</td>
                    <td style="color:${isExp ? 'red' : 'green'}; font-weight:bold">${emp.idExpiry ? new Date(emp.idExpiry).toLocaleDateString('en-GB') : '-'}</td>
                    <td>
                        <div style="display:flex; gap:5px; justify-content:center">
                            <button class="btn btn-whatsapp" onclick="window.open('${waLink}')" title="واتساب"><i class="fab fa-whatsapp"></i></button>
                            <button class="btn btn-info" onclick="viewDetails('${emp._id}')" title="عرض وتعديل"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-danger" onclick="deleteEmployee('${emp._id}')" title="حذف"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function renderStats(response) {
        const data = response.employees;
        const hStats = response.healthStats;
        const lics = response.licenseStats;

        const saudis = data.filter(e => (e.nationality || "").includes("سعودي") || (e.idNumber || "").startsWith('1')).length;
        const residents = data.length - saudis;
        const expiredCount = data.filter(e => e.idExpiry && new Date(e.idExpiry) < new Date()).length;

        document.getElementById('statsContainer').innerHTML = `
            <div class="stat-card blue">
                <div class="info">
                    <h3>إجمالي الكادر</h3>
                    <div class="value">${data.length}</div>
                    <div style="font-size: 0.75rem; color: #555; margin-top: 5px;">
                         سعودي: ${saudis} | مقيم: ${residents}
                    </div>
                </div>
                <i class="fas fa-users-gear"></i>
            </div>

            <div class="stat-card orange" onclick="goToLicenses()" style="cursor:pointer">
                <div class="info">
                    <h3>السجلات والتراخيص</h3>
                    <div class="value">${lics.expired}</div>
                    <small style="color:#666; font-weight:bold;">${lics.expired > 0 ? '⚠️ سجلات منتهية' : 'بلدي | تجاري | سلامة'}</small>
                </div>
                <i class="fas fa-file-shield"></i>
            </div>

            <div class="stat-card green" onclick="goToHealthCertificates()" style="cursor:pointer">
                <div class="info">
                    <h3>الشهادات الصحية</h3>
                    <div class="value">${hStats.total}</div>
                    <small style="color:#666; font-weight:bold;">المنتهية: ${hStats.expired}</small>
                </div>
                <i class="fas fa-heart-circle-check"></i>
            </div>

            <div class="stat-card red">
                <div class="info">
                    <h3>إقامات منتهية</h3>
                    <div class="value">${expiredCount}</div>
                    <small style="color:#666; font-weight:bold;">تنبيهات النظام</small>
                </div>
                <i class="fas fa-triangle-exclamation"></i>
            </div>
        `;
    }

    // --- باقي الدوال (Search, Details, Edit, Excel) تبقى كما هي ---
    function filterByStatus(status, btn) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const today = new Date();
        const thirtyDaysFromNow = new Date();
        thirtyDaysFromNow.setDate(today.getDate() + 30);

        let filteredData = rawData;
        if (status === 'expired') {
            filteredData = rawData.filter(emp => emp.idExpiry && new Date(emp.idExpiry) < today);
        } else if (status === 'near') {
            filteredData = rawData.filter(emp => {
                const expDate = new Date(emp.idExpiry);
                return emp.idExpiry && expDate >= today && expDate <= thirtyDaysFromNow;
            });
        } else if (status === 'valid') {
            filteredData = rawData.filter(emp => emp.idExpiry && new Date(emp.idExpiry) > thirtyDaysFromNow);
        }
        renderTable(filteredData);
    }

    function handleSearch() {
        const term = document.getElementById('mainSearch').value.toLowerCase();
        const filtered = rawData.filter(e => e.fullName.toLowerCase().includes(term) || e.idNumber.includes(term));
        renderTable(filtered);
    }

    function viewDetails(id) {
        const emp = rawData.find(e => e._id === id);
        if(!emp) return;
        document.getElementById('det_title').innerText = emp.fullName;
        document.getElementById('btn_edit_trigger').onclick = () => openEditModal(emp._id);
        const body = document.getElementById('detailsBody');
        body.innerHTML = `
            <div class="details-grid">
                <div class="info-mini-card"><label>رقم الهوية</label><span>${emp.idNumber}</span></div>
                <div class="info-mini-card blue"><label>الجنسية</label><span>${emp.nationality || '-'}</span></div>
                <div class="info-mini-card ${emp.gender === 'female' ? 'pink' : 'blue'}"><label>الجنس</label><span>${emp.gender === 'female' ? 'أنثى' : 'ذكر'}</span></div>
                <div class="info-mini-card orange"><label>انتهاء الهوية</label><span>${emp.idExpiry ? new Date(emp.idExpiry).toLocaleDateString('en-GB') : '-'}</span></div>
                <div class="info-mini-card"><label>رقم الجوال</label><span>${emp.phoneNumber}</span></div>
                <div class="info-mini-card green"><label>التأمين الطبي</label><span>${emp.hasHealthInsurance ? '✅ موجود' : '❌ غير موجود'}</span></div>
                <div class="info-mini-card orange"><label>انتهاء الجواز</label><span>${emp.passportExpiry ? new Date(emp.passportExpiry).toLocaleDateString('en-GB') : '-'}</span></div>
                <div class="info-mini-card blue"><label>السيارة (العهدة)</label><span>${emp.carPlate || 'لا يوجد'}</span></div>
                <div class="info-mini-card"><label>المسمى الوظيفي</label><span>${emp.jobTitle || 'موظف'}</span></div>
            </div>
        `;
        document.getElementById('detailsModal').style.display = 'block';
    }

    function openEditModal(id) {
        const emp = rawData.find(e => e._id === id);
        if(!emp) return;
        closeModal('detailsModal');
        document.getElementById('edit_id').value = emp._id;
        document.getElementById('edit_fullName').value = emp.fullName;
        document.getElementById('edit_phoneNumber').value = emp.phoneNumber;
        document.getElementById('edit_gender').value = emp.gender || 'male';
        document.getElementById('edit_idExpiry').value = emp.idExpiry ? emp.idExpiry.split('T')[0] : '';
        document.getElementById('edit_passportExpiry').value = emp.passportExpiry ? emp.passportExpiry.split('T')[0] : '';
        document.getElementById('edit_carPlate').value = emp.carPlate || '';
        document.getElementById('edit_hasHealthInsurance').value = emp.hasHealthInsurance.toString();
        document.getElementById('edit_nationality').value = emp.nationality || '';
        document.getElementById('edit_jobTitle').value = emp.jobTitle || '';
        document.getElementById('editModal').style.display = 'block';
    }

    document.getElementById('editForm').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('edit_id').value;
        const updatedData = {
            fullName: document.getElementById('edit_fullName').value,
            phoneNumber: document.getElementById('edit_phoneNumber').value,
            gender: document.getElementById('edit_gender').value,
            idExpiry: document.getElementById('edit_idExpiry').value,
            passportExpiry: document.getElementById('edit_passportExpiry').value,
            carPlate: document.getElementById('edit_carPlate').value,
            hasHealthInsurance: document.getElementById('edit_hasHealthInsurance').value === 'true',
            nationality: document.getElementById('edit_nationality').value,
            jobTitle: document.getElementById('edit_jobTitle').value
        };
        try {
            const res = await fetch(`/manager/api/update-employee/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
            });
            if(res.ok) {
                showToast("✅ تم تحديث البيانات بنجاح");
                closeModal('editModal');
                init();
            }
        } catch (e) { showToast("❌ فشل التحديث", true); }
    };

    function showToast(msg, isError = false) {
        const t = document.getElementById('toast');
        if(t) {
            t.innerText = msg; t.style.background = isError ? 'var(--danger)' : 'var(--navy)';
            t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 3000);
        }
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    function copyRegLink() { 
        const activeScope = getSafeScope();
        navigator.clipboard.writeText(`${window.location.origin}/employee/register?scope=${activeScope}`); 
        showToast("تم نسخ رابط التسجيل"); 
    }
    
    async function deleteEmployee(id) { 
        if(!confirm("هل أنت متأكد؟")) return; 
        try {
            const res = await fetch(`/manager/api/delete-employee/${id}`, { method: 'DELETE' }); 
            if(res.ok) init();
        } catch (e) { showToast("فشل الحذف", true); }
    }

    function exportToExcel() {
        const exportData = rawData.map(e => ({
            "الاسم الكامل": e.fullName,
            "الجنس": e.gender === 'female' ? 'أنثى' : 'ذكر',
            "رقم الهوية": e.idNumber,
            "الجنسية": e.nationality || 'غير محدد',
            "رقم الجوال": e.phoneNumber,
            "انتهاء الهوية": e.idExpiry ? new Date(e.idExpiry).toLocaleDateString('en-GB') : '-',
            "المسمى الوظيفي": e.jobTitle || 'موظف'
        }));
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Staff");
        XLSX.writeFile(wb, "GoldenCloud_Staff_Report.xlsx");
    }

    function logout() { localStorage.clear(); window.location.href = '/'; }

    window.onpageshow = function(event) { if (event.persisted) { init(); } };
    window.onload = init;
    function goToWages() {
    const activeScope = getSafeScope();
    if(activeScope) {
        // سيقوم هذا الرابط بالتوجه لصفحة الأجور مع الحفاظ على النطاق النشط
        window.location.href = `/manager/wages?scope=${activeScope}`;
    } else {
        showToast("عذراً: كود النطاق مفقود، يرجى إعادة تحميل الصفحة", true);
    }
}
</script>
</body>
</html>