<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة الأجور | Golden Cloud Server</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --navy: #0b1d2a; --gold: #ffcc00; --bg-light: #f4f7f6;
            --white: #ffffff; --danger: #ff4d4d; --success: #27ae60;
        }

        body { font-family: 'Tajawal', sans-serif; background: var(--bg-light); margin: 0; color: #333; }

        header { 
            background: linear-gradient(135deg, var(--navy) 0%, #162e3e 100%);
            color: var(--gold); padding: 15px 40px; display: flex; 
            justify-content: space-between; align-items: center;
            box-shadow: 0 4px 25px rgba(0,0,0,0.3); position: sticky; top: 0; z-index: 1000;
        }

        .logo-section { display: flex; align-items: center; gap: 20px; }
        .scope-badge { 
            background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 50px; 
            color: #fff; font-weight: 700; border: 1px solid var(--gold);
        }

        .gov-bar {
            background: #fdfdfd; padding: 10px 20px; display: flex; gap: 12px;
            align-items: center; border-bottom: 2px solid #eee; overflow-x: auto;
        }

        .gov-link {
            text-decoration: none; color: var(--navy); padding: 6px 15px;
            border-radius: 8px; background: #eee; font-weight: 700;
            display: inline-flex; align-items: center; gap: 8px; flex-shrink: 0; font-size: 0.85rem;
        }

        .container { max-width: 1600px; margin: 0 auto; padding: 30px; }

        .table-card { background: var(--white); border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        thead th { background: var(--navy); color: var(--gold); padding: 18px; font-size: 0.9rem; border-bottom: 2px solid var(--gold); }
        tbody td { padding: 15px; text-align: center; border-bottom: 1px solid #f0f0f0; font-weight: 700; }

        .emp-name { color: var(--navy); font-weight: 800; font-size: 1rem; display: block; }
        .emp-id { color: #777; font-size: 0.8rem; }
        .net-box { background: #e3f2fd; color: #1565c0; padding: 8px 15px; border-radius: 8px; font-weight: 800; }

        .btn { padding: 10px 18px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-family: inherit; text-decoration: none; font-size: 0.85rem; }
        .btn-gold { background: var(--gold); color: var(--navy); }
        .btn-white { background: #fff; color: var(--navy); }
        .btn-outline { background: transparent; color: var(--gold); border: 2px solid var(--gold); }
        
        .btn-edit { color: #2980b9; background: #ebf5fb; border: 1px solid #d4e6f1; padding: 5px 10px; border-radius: 6px; cursor: pointer; margin-left: 5px; }
        .btn-delete { color: #c0392b; background: #fdedec; border: 1px solid #fadbd8; padding: 5px 10px; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <div class="logo-section">
        <i class="fas fa-server fa-2x"></i>
        <div>
            <h2 style="margin:0; font-size: 1.4rem;">Golden Cloud Server</h2>
            <div id="scopeNameDisplay" class="scope-badge">جاري التحميل...</div>
        </div>
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-white" onclick="goToClearance()">
            <i class="fas fa-file-contract"></i> المخالصات
        </button>
        <button class="btn btn-gold" onclick="copyEntryLink()">
            <i class="fas fa-link"></i> رابط التسجيل
        </button>
        <a href="/manager/dashboard" id="backLink" class="btn btn-outline">
            العودة للوحة الإدارة <i class="fas fa-chevron-left"></i>
        </a>
    </div>
</header>

<div class="gov-bar">
    <span style="font-weight: 800; color: var(--navy); border-left: 2px solid #ddd; padding-left: 10px;">المنصات:</span>
    <a href="https://www.qiwa.sa" target="_blank" class="gov-link">قوى</a>
    <a href="https://www.mudad.com.sa" target="_blank" class="gov-link">مدد</a>
    <a href="https://muqeem.sa" target="_blank" class="gov-link">مقيم</a>
</div>

<div class="container">
    <div class="table-card">
        <table>
            <thead>
                <tr>
                    <th>الموظف</th>
                    <th>الأساسي</th>
                    <th>سكن/نقل</th>
                    <th>ب. إجازة (30%)</th>
                    <th>إضافي (70%)</th>
                    <th>الخصم</th>
                    <th>صافي المستحق</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody id="wagesTableBody">
                <tr><td colspan="8">جاري جلب بيانات الأجور...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    let currentScope = new URLSearchParams(window.location.search).get('scope') || localStorage.getItem('last_active_scope');

    async function init() {
        if (!currentScope) return;
        document.getElementById('backLink').href = `/manager/dashboard?scope=${currentScope}`;
        await fetchScopeInfo(currentScope);
        await loadWagesData(currentScope);
    }

    async function fetchScopeInfo(id) {
        try {
            const res = await fetch(`/manager/api/get-scope-info/${id}`);
            const data = await res.json();
            document.getElementById('scopeNameDisplay').innerText = data.name || "نطاق غير مسمى";
        } catch (e) { document.getElementById('scopeNameDisplay').innerText = "خطأ في الاتصال"; }
    }

    async function loadWagesData(id) {
        try {
            const res = await fetch(`/manager/api/get-wages/${id}`);
            const data = await res.json();
            renderTable(data);
        } catch (e) { document.getElementById('wagesTableBody').innerHTML = '<tr><td colspan="8">فشل التحميل</td></tr>'; }
    }

    function renderTable(wages) {
        const tbody = document.getElementById('wagesTableBody');
        if(!wages || wages.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8">لا توجد بيانات</td></tr>';
            return;
        }
        tbody.innerHTML = wages.map(emp => {
            const total = parseFloat(emp.totalSalary) || 0;
            const deduct = parseFloat(emp.deduction) || 0;
            // نستخدم البيانات المحسوبة القادمة من السيرفر (المعادلة 70:30)
            const basic = emp.basicSalary || 400;
            const housing = emp.housingTransportAllowance || 50;
            const holiday = emp.fridayPay || 0;
            const overtime = emp.overtimePay || 0;
            const net = total - deduct;

            return `
                <tr>
                    <td><span class="emp-name">${emp.fullName}</span><span class="emp-id">${emp.idNumber}</span></td>
                    <td>${basic.toFixed(2)}</td>
                    <td>${housing.toFixed(2)}</td>
                    <td style="color:var(--success)">${holiday.toFixed(2)}</td>
                    <td style="color:#e67e22">${overtime.toFixed(2)}</td>
                    <td style="color:var(--danger)">${deduct.toFixed(2)}</td>
                    <td><span class="net-box">${net.toLocaleString()}</span></td>
                    <td>
                        <button class="btn-edit" onclick="updateDeduction('${emp.idNumber}')" title="تعديل الخصم"><i class="fas fa-minus-circle"></i></button>
                        <button class="btn-delete" onclick="confirmDelete('${emp.idNumber}', '${emp.fullName}')" title="حذف الموظف"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>`;
        }).join('');
    }

    function goToClearance() {
        window.location.href = `/manager/clearance?scope=${currentScope}`;
    }

    async function confirmDelete(idNumber, name) {
        const password = prompt(`أدخل كلمة مرور الإدارة لحذف الموظف (${name}):`);
        if (!password) return;

        if (confirm(`هل أنت متأكد من حذف ${name} نهائياً؟`)) {
            try {
                const res = await fetch(`/manager/api/delete-wage/${idNumber}`, { 
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ password: password.trim() })
                });
                const result = await res.json();
                if (result.success) {
                    alert("✅ تم الحذف بنجاح");
                    loadWagesData(currentScope);
                } else { 
                    alert("❌ " + result.message); 
                }
            } catch (e) { alert("❌ فشل الاتصال بالسيرفر"); }
        }
    }

    async function updateDeduction(id) {
        const amount = prompt("أدخل قيمة الخصم الجديد:");
        if (amount === null) return;
        
        const reason = prompt("سبب الخصم:");
        const password = prompt("كلمة مرور الإدارة للتعميد المالي:");
        if (!password) return;

        try {
            const res = await fetch('/manager/api/update-deduction', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    idNumber: id, 
                    deduction: amount, 
                    reason: reason, 
                    password: password.trim() 
                })
            });
            const result = await res.json();
            if (result.success) {
                alert("✅ تم تحديث الخصم");
                loadWagesData(currentScope);
            } else {
                alert("❌ " + result.message);
            }
        } catch (e) { alert("❌ فشل الاتصال"); }
    }

    function copyEntryLink() {
        const url = `${window.location.origin}/wage-entry?scope=${currentScope}`;
        navigator.clipboard.writeText(url);
        alert("✅ تم نسخ رابط التسجيل");
    }

    window.onload = init;
</script>
</body>
</html>