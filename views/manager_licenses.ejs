<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة السجلات والرخص | Golden Cloud</title>
    <div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm overflow-hidden">
            <div class="card-body d-flex justify-content-between align-items-center bg-dark text-white p-2 px-3">
                <small><i class="fas fa-link me-2"></i> روابط التحقق الفوري:</small>
                <div class="btn-group">
                    <a href="https://mc.gov.sa/" target="_blank" class="btn btn-sm btn-warning fw-bold">وزارة التجارة</a>
                    <a href="https://balady.gov.sa/" target="_blank" class="btn btn-sm btn-info text-white fw-bold">منصة بلدي</a>
                    <a href="https://998.gov.sa/Arabic/Salami/Pages/default.aspx" target="_blank" class="btn btn-sm btn-danger fw-bold">بوابة سلامة</a>
                </div>
            </div>
        </div>
    </div>
</div>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --navy: #0b1d2a; --gold: #ffcc00; --bg: #f8fafc; 
            --danger: #ff4757; --success: #2ed573; --warning: #ffa502;
            --white: #ffffff; --gray: #64748b; --border: #e2e8f0;
        }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); margin: 0; color: var(--navy); }
        header { 
            background: var(--navy); color: var(--gold); padding: 12px 30px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000;
        }
        .container { max-width: 1300px; margin: 20px auto; padding: 0 20px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; gap: 15px; flex-wrap: wrap; }
        .search-box { 
            background: var(--white); flex: 1; min-width: 300px;
            display: flex; align-items: center; padding: 5px 15px;
            border-radius: 12px; border: 1px solid var(--border); transition: 0.3s;
        }
        .search-box input { border: none; outline: none; padding: 10px; width: 100%; font-family: 'Tajawal'; font-size: 1rem; }
        .fab-add {
            background: var(--navy); color: var(--gold); border: none;
            padding: 12px 25px; border-radius: 12px; cursor: pointer;
            font-weight: bold; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 4px 12px rgba(11, 29, 42, 0.2); transition: 0.3s;
            font-family: 'Tajawal';
        }
        .fab-add:hover { transform: translateY(-3px); background: #152d3f; }
        .card-table { background: var(--white); border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #f1f5f9; color: var(--gray); padding: 15px; font-size: 0.9rem; text-align: center; border-bottom: 2px solid var(--border); }
        td { padding: 15px; border-bottom: 1px solid var(--border); text-align: center; font-size: 0.95rem; }
        .row-expired { border-right: 5px solid var(--danger); }
        .row-warning { border-right: 5px solid var(--warning); }
        .row-safe { border-right: 5px solid var(--success); }
        .suspended { opacity: 0.5; filter: grayscale(1); background: #eee; }
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .badge-red { background: #fee2e2; color: #b91c1c; }
        .badge-orange { background: #ffedd5; color: #c2410c; }
        .badge-green { background: #dcfce7; color: #15803d; }
        .action-btn { width: 35px; height: 35px; border-radius: 8px; border: none; cursor: pointer; color: white; transition: 0.2s; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(11, 29, 42, 0.6); backdrop-filter: blur(4px);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-content { background: var(--white); width: 95%; max-width: 650px; border-radius: 20px; padding: 25px; position: relative; }
        .close-modal { position: absolute; left: 20px; top: 20px; cursor: pointer; color: var(--gray); }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:12px;">
        <i class="fas fa-file-contract fa-lg"></i>
        <h3 style="margin:0; color:var(--gold)">إدارة السجلات القانونية</h3>
    </div>
    <button class="fab-add" id="backBtn" style="background:var(--gold); color:var(--navy); padding:8px 15px;">
        <i class="fas fa-arrow-right"></i> العودة للموظفين
    </button>
</header>

<div class="container">
    <div class="top-bar">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="ابحث باسم المنشأة أو رقم السجل..." onkeyup="filterLicenses()">
        </div>
        
        <div style="display:flex; gap:10px;">
            <select id="filterType" class="filter-select" onchange="filterLicenses()" style="padding:10px; border-radius:10px; border:1px solid var(--border); font-family:'Tajawal'">
                <option value="all">كل الأنواع</option>
                <option value="سجل تجاري">سجل تجاري</option>
                <option value="رخصة بلدي">رخصة بلدي</option>
                <option value="دفاع مدني">دفاع مدني</option>
                <option value="شهادة صحية">شهادة صحية</option>
            </select>
            <button class="fab-add" onclick="openModal()">
                <i class="fas fa-plus-circle"></i> إضافة وثيقة
            </button>
        </div>
    </div>

    <div id="alertSummary" style="margin-bottom: 15px; display: flex; gap: 20px; font-weight: bold;"></div>

    <div class="card-table">
        <div style="overflow-x:auto">
            <table id="licenseTable">
                <thead>
                    <tr>
                        <th style="text-align:right">المنشأة / الفرع</th>
                        <th>النوع</th>
                        <th>رقم الوثيقة</th>
                        <th>تاريخ الانتهاء</th>
                        <th>الحالة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="licenseTableBody">
                    <tr><td colspan="6">جاري تحميل البيانات...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal-overlay" id="licenseModal">
    <div class="modal-content">
        <i class="fas fa-times close-modal" onclick="closeModal()"></i>
        <h3 id="modalTitle"><i class="fas fa-plus-circle"></i> إضافة سجل جديد</h3>
        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
        
        <input type="hidden" id="licenseId">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="grid-column: span 2;">
                <label>اسم المنشأة / الفرع</label>
                <input type="text" id="orgName" placeholder="مثال: فرع الرياض - المستودع" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-top:5px;">
            </div>
            <div>
                <label>نوع الوثيقة</label>
                <select id="licenseType" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-top:5px;">
                    <option>سجل تجاري</option>
                    <option>رخصة بلدي</option>
                    <option>دفاع مدني</option>
                    <option>شهادة صحية</option>
                    <option>الزكاة والدخل</option>
                </select>
            </div>
            <div>
                <label>الرقم الموحد (700)</label>
                <input type="text" id="unifiedNumber" placeholder="700XXXXXXXX" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-top:5px;">
            </div>
            <div>
                <label>رقم السجل / الرخصة</label>
                <input type="text" id="licenseNumber" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-top:5px;">
            </div>
            <div>
                <label>تاريخ الانتهاء</label>
                <input type="date" id="expiryDate" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-top:5px;">
            </div>
        </div>
        
        <button class="fab-add" style="width:100%; justify-content:center; margin-top:25px;" onclick="saveLicense()">
            <i class="fas fa-save"></i> حفظ البيانات
        </button>
    </div>
</div>

<script>
    // ✅ تصحيح جلب الـ scopeId من الرابط (المصدر الموثوق)
    const urlParams = new URLSearchParams(window.location.search);
    const scopeId = urlParams.get('scope');

    // تفعيل زر العودة
    document.getElementById('backBtn').onclick = () => {
        window.location.href = `/manager/dashboard?scope=${scopeId}`;
    };

    let allLicenses = [];

    function openModal() { resetForm(); document.getElementById('licenseModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('licenseModal').style.display = 'none'; }

    async function loadLicenses() {
        if(!scopeId) return alert("خطأ: لم يتم العثور على معرف المنشأة في الرابط");
        try {
            const res = await fetch(`/manager/licenses/api/all/${scopeId}`);
            allLicenses = await res.json();
            renderLicenses(allLicenses);
        } catch (e) { console.error("Error loading licenses"); }
    }

    function renderLicenses(data) {
        const body = document.getElementById('licenseTableBody');
        body.innerHTML = '';
        if(data.length === 0) {
            body.innerHTML = '<tr><td colspan="6">لا توجد سجلات مضافة حالياً</td></tr>';
            return;
        }

        let counts = { expired: 0, warning: 0 };

        data.forEach(lic => {
            const days = calculateDays(lic.expiryDate);
            const isSuspended = lic.status === 'suspended';
            
            let statusBadge, rowClass;
            if (days < 0) {
                statusBadge = '<span class="badge badge-red">منتهي</span>';
                rowClass = 'row-expired';
                counts.expired++;
            } else if (days <= 30) {
                statusBadge = '<span class="badge badge-orange">قرب الانتهاء</span>';
                rowClass = 'row-warning';
                counts.warning++;
            } else {
                statusBadge = '<span class="badge badge-green">ساري</span>';
                rowClass = 'row-safe';
            }

            const tr = document.createElement('tr');
            tr.className = isSuspended ? 'suspended' : rowClass;
            tr.innerHTML = `
                <td style="text-align:right; font-weight:bold;">${lic.orgName}</td>
                <td><span style="color:var(--gray)">${lic.licenseType}</span></td>
                <td><code>${lic.licenseNumber}</code></td>
                <td>${new Date(lic.expiryDate).toLocaleDateString('ar-SA')} <br><small style="color:${days < 0 ? 'red' : '#666'}">(${days} يوم)</small></td>
                <td>${statusBadge}</td>
                <td>
                    <div style="display:flex; gap:5px; justify-content:center;">
                        <button class="action-btn" style="background:#6366f1" onclick="editLic('${lic._id}')"><i class="fas fa-pen"></i></button>
                        <button class="action-btn" style="background:#94a3b8" onclick="toggleStatus('${lic._id}', '${isSuspended ? 'active' : 'suspended'}')">
                            <i class="fas ${isSuspended ? 'fa-play' : 'fa-pause'}"></i>
                        </button>
                        <button class="action-btn" style="background:var(--danger)" onclick="deleteLic('${lic._id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            `;
            body.appendChild(tr);
        });

        document.getElementById('alertSummary').innerHTML = `
            <span style="color:var(--danger)"><i class="fas fa-exclamation-triangle"></i> منتهية: ${counts.expired}</span>
            <span style="color:var(--warning)"><i class="fas fa-clock"></i> قريبة الانتهاء: ${counts.warning}</span>
        `;
    }

    async function saveLicense() {
        const payload = {
            id: document.getElementById('licenseId').value,
            scopeId: scopeId, // ✅ التأكد من إرسال الـ scopeId الصحيح
            licenseType: document.getElementById('licenseType').value,
            orgName: document.getElementById('orgName').value,
            unifiedNumber: document.getElementById('unifiedNumber').value,
            licenseNumber: document.getElementById('licenseNumber').value,
            expiryDate: document.getElementById('expiryDate').value
        };

        if(!payload.orgName || !payload.expiryDate || !payload.licenseNumber) return alert("يرجى إكمال البيانات الأساسية (الاسم، الرقم، التاريخ)");

        try {
            const res = await fetch('/manager/licenses/api/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if(res.ok) {
                closeModal();
                loadLicenses(); // تحديث القائمة فوراً
            }
        } catch (err) { alert("حدث خطأ أثناء الحفظ"); }
    }

    function editLic(id) {
        const lic = allLicenses.find(l => l._id === id);
        document.getElementById('licenseId').value = lic._id;
        document.getElementById('orgName').value = lic.orgName;
        document.getElementById('licenseType').value = lic.licenseType;
        document.getElementById('unifiedNumber').value = lic.unifiedNumber;
        document.getElementById('licenseNumber').value = lic.licenseNumber;
        document.getElementById('expiryDate').value = lic.expiryDate.split('T')[0];
        document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> تعديل بيانات الوثيقة';
        document.getElementById('licenseModal').style.display = 'flex';
    }

    async function deleteLic(id) {
        if(confirm('هل تريد حذف هذه الوثيقة نهائياً؟')) {
            await fetch(`/manager/licenses/api/delete/${id}`, { method: 'DELETE' });
            loadLicenses();
        }
    }

    async function toggleStatus(id, status) {
        await fetch('/manager/licenses/api/status', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id, status })
        });
        loadLicenses();
    }

    function calculateDays(date) {
        const diff = new Date(date) - new Date();
        return Math.ceil(diff / (1000 * 60 * 60 * 24));
    }

    function filterLicenses() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const type = document.getElementById('filterType').value;
        const filtered = allLicenses.filter(l => 
            (l.orgName.toLowerCase().includes(q) || l.licenseNumber.includes(q)) &&
            (type === 'all' || l.licenseType === type)
        );
        renderLicenses(filtered);
    }

    function resetForm() {
        document.getElementById('licenseId').value = '';
        document.getElementById('orgName').value = '';
        document.getElementById('licenseNumber').value = '';
        document.getElementById('expiryDate').value = '';
        document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus-circle"></i> إضافة سجل جديد';
    }

    loadLicenses();
</script>
</body>
</html>