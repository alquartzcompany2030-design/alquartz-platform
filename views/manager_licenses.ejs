<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØ§Ù„Ø±Ø®Øµ | Golden Cloud</title>
    <div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm overflow-hidden">
            <div class="card-body d-flex justify-content-between align-items-center bg-dark text-white p-2 px-3">
                <small><i class="fas fa-link me-2"></i> Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ÙÙˆØ±ÙŠ:</small>
                <div class="btn-group">
                    <a href="https://mc.gov.sa/" target="_blank" class="btn btn-sm btn-warning fw-bold">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¬Ø§Ø±Ø©</a>
                    <a href="https://balady.gov.sa/" target="_blank" class="btn btn-sm btn-info text-white fw-bold">Ù…Ù†ØµØ© Ø¨Ù„Ø¯ÙŠ</a>
                    <a href="https://998.gov.sa/Arabic/Salami/Pages/default.aspx" target="_blank" class="btn btn-sm btn-danger fw-bold">Ø¨ÙˆØ§Ø¨Ø© Ø³Ù„Ø§Ù…Ø©</a>
                </div>
            </div>
        </div>
    </div>
</div>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --navy: #0b1d2a; --gold: #ffcc00; --bg: #f8fafc; 
            --danger: #ff4757; --success: #2ed573; --warning: #ffa502;
            --white: #ffffff; --gray: #64748b; --border: #e2e8f0;
        }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); margin: 0; color: var(--navy); }
        header { 
            background: var(--navy); color: var(--gold); padding: 12px 30px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000;
        }
        .container { max-width: 1300px; margin: 20px auto; padding: 0 20px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; gap: 15px; flex-wrap: wrap; }
        .search-box { 
            background: var(--white); flex: 1; min-width: 300px;
            display: flex; align-items: center; padding: 5px 15px;
            border-radius: 12px; border: 1px solid var(--border); transition: 0.3s;
        }
        .search-box input { border: none; outline: none; padding: 10px; width: 100%; font-family: 'Tajawal'; font-size: 1rem; }
        .fab-add {
            background: var(--navy); color: var(--gold); border: none;
            padding: 12px 25px; border-radius: 12px; cursor: pointer;
            font-weight: bold; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 4px 12px rgba(11, 29, 42, 0.2); transition: 0.3s;
            font-family: 'Tajawal';
        }
        .fab-add:hover { transform: translateY(-3px); background: #152d3f; }
        .card-table { background: var(--white); border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #f1f5f9; color: var(--gray); padding: 15px; font-size: 0.9rem; text-align: center; border-bottom: 2px solid var(--border); }
        td { padding: 15px; border-bottom: 1px solid var(--border); text-align: center; font-size: 0.95rem; }
        .row-expired { border-right: 5px solid var(--danger); }
        .row-warning { border-right: 5px solid var(--warning); }
        .row-safe { border-right: 5px solid var(--success); }
        .suspended { opacity: 0.5; filter: grayscale(1); background: #eee; }
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .badge-red { background: #fee2e2; color: #b91c1c; }
        .badge-orange { background: #ffedd5; color: #c2410c; }
        .badge-green { background: #dcfce7; color: #15803d; }
        .action-btn { width: 35px; height: 35px; border-radius: 8px; border: none; cursor: pointer; color: white; transition: 0.2s; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(11, 29, 42, 0.6); backdrop-filter: blur(4px);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-content { background: var(--white); width: 95%; max-width: 650px; border-radius: 20px; padding: 25px; position: relative; }
        .close-modal { position: absolute; left: 20px; top: 20px; cursor: pointer; color: var(--gray); }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:12px;">
        <i class="fas fa-file-contract fa-lg"></i>
        <h3 style="margin:0; color:var(--gold)">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©</h3>
    </div>
    <button class="fab-add" id="backBtn" style="background:var(--gold); color:var(--navy); padding:8px 15px;">
        <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†
    </button>
</header>

<div class="container">
    <div class="top-bar">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø© Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„..." onkeyup="filterLicenses()">
        </div>
        
        <div style="display:flex; gap:10px;">
            <select id="filterType" class="filter-select" onchange="filterLicenses()" style="padding:10px; border-radius:10px; border:1px solid var(--border); font-family:'Tajawal'">
                <option value="all">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                <option value="Ø³Ø¬Ù„ ØªØ¬Ø§Ø±ÙŠ">Ø³Ø¬Ù„ ØªØ¬Ø§Ø±ÙŠ</option>
                <option value="Ø±Ø®ØµØ© Ø¨Ù„Ø¯ÙŠ">Ø±Ø®ØµØ© Ø¨Ù„Ø¯ÙŠ</option>
                <option value="Ø¯ÙØ§Ø¹ Ù…Ø¯Ù†ÙŠ">Ø¯ÙØ§Ø¹ Ù…Ø¯Ù†ÙŠ</option>
                <option value="Ø´Ù‡Ø§Ø¯Ø© ØµØ­ÙŠØ©">Ø´Ù‡Ø§Ø¯Ø© ØµØ­ÙŠØ©</option>
            </select>
            <button class="fab-add" onclick="openModal()">
                <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© ÙˆØ«ÙŠÙ‚Ø©
            </button>
        </div>
    </div>

    <div id="alertSummary" style="margin-bottom: 15px; display: flex; gap: 20px; font-weight: bold;"></div>

    <div class="card-table">
        <div style="overflow-x:auto">
            <table id="licenseTable">
                <thead>
                    <tr>
                        <th style="text-align:right">Ø§Ù„Ù…Ù†Ø´Ø£Ø© / Ø§Ù„ÙØ±Ø¹</th>
                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                        <th>Ø±Ù‚Ù… Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="licenseTableBody">
                    <tr><td colspan="6">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal-overlay" id="licenseModal">
    <div class="modal-content">
        <i class="fas fa-times close-modal" onclick="closeModal()"></i>
        <h3 id="modalTitle"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯</h3>
        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
        
        <input type="hidden" id="licenseId">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="grid-column: span 2;">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø© / Ø§Ù„ÙØ±Ø¹</label>
                <input type="text" id="orgName" placeholder="Ù…Ø«Ø§Ù„: ÙØ±Ø¹ Ø§Ù„Ø±ÙŠØ§Ø¶ - Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-top:5px;">
            </div>
            <div>
                <label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</label>
                <select id="licenseType" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-top:5px;">
                    <option>Ø³Ø¬Ù„ ØªØ¬Ø§Ø±ÙŠ</option>
                    <option>Ø±Ø®ØµØ© Ø¨Ù„Ø¯ÙŠ</option>
                    <option>Ø¯ÙØ§Ø¹ Ù…Ø¯Ù†ÙŠ</option>
                    <option>Ø´Ù‡Ø§Ø¯Ø© ØµØ­ÙŠØ©</option>
                    <option>Ø§Ù„Ø²ÙƒØ§Ø© ÙˆØ§Ù„Ø¯Ø®Ù„</option>
                </select>
            </div>
            <div>
                <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ­Ø¯ (700)</label>
                <input type="text" id="unifiedNumber" placeholder="700XXXXXXXX" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-top:5px;">
            </div>
            <div>
                <label>Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ / Ø§Ù„Ø±Ø®ØµØ©</label>
                <input type="text" id="licenseNumber" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-top:5px;">
            </div>
            <div>
                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label>
                <input type="date" id="expiryDate" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-top:5px;">
            </div>
        </div>
        
        <button class="fab-add" style="width:100%; justify-content:center; margin-top:25px;" onclick="saveLicense()">
            <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </button>
    </div>
</div>

<script>
    // âœ… Ø¬Ù„Ø¨ Ø§Ù„Ù€ scopeId Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    const urlParams = new URLSearchParams(window.location.search);
    const scopeId = urlParams.get('scope');

    // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø©
    document.getElementById('backBtn').onclick = () => {
        window.location.href = `/manager/dashboard?scope=${scopeId}`;
    };

    let allLicenses = [];

    function openModal() { resetForm(); document.getElementById('licenseModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('licenseModal').style.display = 'none'; }

    async function loadLicenses() {
        if(!scopeId) return alert("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†Ø´Ø£Ø©");
        try {
            const res = await fetch(`/manager/licenses/api/all/${scopeId}`);
            allLicenses = await res.json();
            renderLicenses(allLicenses);
        } catch (e) { console.error("Error loading licenses"); }
    }

    function renderLicenses(data) {
        const body = document.getElementById('licenseTableBody');
        body.innerHTML = '';
        if(data.length === 0) {
            body.innerHTML = '<tr><td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø¶Ø§ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>';
            return;
        }

        let counts = { expired: 0, warning: 0 };

        data.forEach(lic => {
            const days = calculateDays(lic.expiryDate);
            const isSuspended = lic.status === 'suspended';
            
            let statusBadge, rowClass;
            if (days < 0) {
                statusBadge = '<span class="badge badge-red">Ù…Ù†ØªÙ‡ÙŠ</span>';
                rowClass = 'row-expired';
                counts.expired++;
            } else if (days <= 30) {
                statusBadge = '<span class="badge badge-orange">Ù‚Ø±Ø¨ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</span>';
                rowClass = 'row-warning';
                counts.warning++;
            } else {
                statusBadge = '<span class="badge badge-green">Ø³Ø§Ø±ÙŠ</span>';
                rowClass = 'row-safe';
            }

            const tr = document.createElement('tr');
            tr.className = isSuspended ? 'suspended' : rowClass;
            tr.innerHTML = `
                <td style="text-align:right; font-weight:bold;">${lic.orgName}</td>
                <td><span style="color:var(--gray)">${lic.licenseType}</span></td>
                <td><code>${lic.licenseNumber}</code></td>
                <td>${new Date(lic.expiryDate).toLocaleDateString('ar-SA')} <br><small style="color:${days < 0 ? 'red' : '#666'}">(${days} ÙŠÙˆÙ…)</small></td>
                <td>${statusBadge}</td>
                <td>
                    <div style="display:flex; gap:5px; justify-content:center;">
                        <button class="action-btn" style="background:#6366f1" onclick="editLic('${lic._id}')"><i class="fas fa-pen"></i></button>
                        <button class="action-btn" style="background:#94a3b8" onclick="toggleStatus('${lic._id}', '${isSuspended ? 'active' : 'suspended'}')">
                            <i class="fas ${isSuspended ? 'fa-play' : 'fa-pause'}"></i>
                        </button>
                        <button class="action-btn" style="background:var(--danger)" onclick="deleteLic('${lic._id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            `;
            body.appendChild(tr);
        });

        document.getElementById('alertSummary').innerHTML = `
            <span style="color:var(--danger)"><i class="fas fa-exclamation-triangle"></i> Ù…Ù†ØªÙ‡ÙŠØ©: ${counts.expired}</span>
            <span style="color:var(--warning)"><i class="fas fa-clock"></i> Ù‚Ø±ÙŠØ¨Ø© Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: ${counts.warning}</span>
        `;
    }

    async function saveLicense() {
        const payload = {
            id: document.getElementById('licenseId').value,
            scopeId: scopeId,
            licenseType: document.getElementById('licenseType').value,
            orgName: document.getElementById('orgName').value,
            unifiedNumber: document.getElementById('unifiedNumber').value,
            licenseNumber: document.getElementById('licenseNumber').value,
            expiryDate: document.getElementById('expiryDate').value
        };

        if(!payload.orgName || !payload.expiryDate || !payload.licenseNumber) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©");

        try {
            const res = await fetch('/manager/licenses/api/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if(res.ok) { closeModal(); loadLicenses(); }
        } catch (err) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸"); }
    }

    function editLic(id) {
        const lic = allLicenses.find(l => l._id === id);
        document.getElementById('licenseId').value = lic._id;
        document.getElementById('orgName').value = lic.orgName;
        document.getElementById('licenseType').value = lic.licenseType;
        document.getElementById('unifiedNumber').value = lic.unifiedNumber;
        document.getElementById('licenseNumber').value = lic.licenseNumber;
        document.getElementById('expiryDate').value = lic.expiryDate.split('T')[0];
        document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©';
        document.getElementById('licenseModal').style.display = 'flex';
    }

async function deleteLic(id) {
    // 1. Ù†Ø·Ù„Ø¨ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯
    const password = prompt("ğŸ” Ø£Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª: Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…ÙˆØ­Ø¯Ø©:");
    if (!password) return; 

    if(confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) {
        try {
            // 2. Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø°ÙŠ ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø£Ø®ÙŠØ±
            const url = `/manager/licenses/secure-delete/${id}?password=${encodeURIComponent(password.trim())}`;
            
            const res = await fetch(url, { 
                method: 'DELETE' // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù†ÙˆØ¹ DELETE
            });

            const result = await res.json();
            
            if(result.success) {
                alert("âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­");
                loadLicenses(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
            } else {
                // Ù‡Ù†Ø§ Ø³ÙŠÙ‚Ù Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆÙŠØ®Ø¨Ø±Ùƒ Ø£Ù† Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ØºÙ„Ø·
                alert("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: " + result.message);
            }
        } catch (e) { 
            alert("Ø®Ø·Ø£: ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±"); 
        }
    }
}
    async function toggleStatus(id, status) {
        await fetch('/manager/licenses/api/status', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id, status })
        });
        loadLicenses();
    }

    function calculateDays(date) {
        const diff = new Date(date) - new Date();
        return Math.ceil(diff / (1000 * 60 * 60 * 24));
    }

    function filterLicenses() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const type = document.getElementById('filterType').value;
        const filtered = allLicenses.filter(l => 
            (l.orgName.toLowerCase().includes(q) || l.licenseNumber.includes(q)) &&
            (type === 'all' || l.licenseType === type)
        );
        renderLicenses(filtered);
    }

    function resetForm() {
        document.getElementById('licenseId').value = '';
        document.getElementById('orgName').value = '';
        document.getElementById('licenseNumber').value = '';
        document.getElementById('expiryDate').value = '';
        document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯';
    }

    loadLicenses();
</script>
</body>
</html>